FROM repoweb-microsrv.intra.fazenda.sp.gov.br:5000/dotnet/aspnet:3.1-alpine

#Argumentos passados no Build
ARG user
ARG pass

#Adiciona usuario do Container (Non Root)
RUN adduser -D  app

WORKDIR /var/api/modelo_core_webapi
EXPOSE 80
EXPOSE 443

#
ENV DOTNET_SYSTEM_GLOBALIZATION_INVARIANT=false

#Instala dependencias (Globalization e autenticação Kerberos)
RUN https_proxy=http://proxyservidores.lbintra.fazenda.sp.gov.br:8080 apk add icu-libs krb5

#Copia arquivos da aplicação
COPY . .

#Copia arquivo de configuração para autenticação Kerberos
COPY krb5.conf /etc/krb5.conf

#Concede permissão para o usuario no WorkDir
RUN chown -R app .
#Executa entrypoint como Non Root
USER app

#Inicia ticket de autenticação Kerberos
RUN echo "$pass" |kinit $user@INTRA.FAZENDA.SP.GOV.BR

ENTRYPOINT ["dotnet", "modelo_core_webapi.dll"]